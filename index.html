<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>JSON Dialogue TTS Reader</title>
Â  Â  <style>
Â  Â  Â  Â  body { font-family: Arial, sans-serif; padding: 20px; }
Â  Â  Â  Â  .controls, .dialogue-controls, .how-to-use { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
Â  Â  Â  Â  .dialogue-line { margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #eee; cursor: pointer; }
Â  Â  Â  Â  .dialogue-line:hover { background-color: #f0f0f0; }
Â  Â  Â  Â  .speaker { font-weight: bold; margin-right: 10px; color: #0056b3; }
Â  Â  Â  Â  .current-speaking { background-color: #e6f7ff; border-left: 5px solid #007bff; }
Â  Â  Â  Â  label { display: block; margin-bottom: 5px; font-aweight: bold; }
Â  Â  Â  Â  input[type="range"] { width: 300px; }
Â  Â  Â  Â  button { padding: 10px 15px; margin-right: 10px; cursor: pointer; }
Â  Â  Â  Â  #log { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; font-size: 0.9em; }
Â  Â  Â  Â  .how-to-use { background-color: #e6f7ff; border-color: #b3d9ff; }
Â  Â  Â  Â  .how-to-use ol li { margin-bottom: 10px; }
Â  Â  Â  Â  .download-links { margin-top: 15px; font-size: 0.95em; }
Â  Â  </style>
</head>
<body>

Â  Â  <h1>ğŸ—£ï¸ JSON Dialogue TTS Reader</h1>

Â  Â  <div class="controls">
Â  Â  Â  Â  <label for="fileInput">Upload JSON Dialogue File:</label>
Â  Â  Â  Â  <input type="file" id="fileInput" accept="application/json">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="download-links">
Â  Â  Â  Â  Â  Â  ğŸ”— **Resources:**
Â  Â  Â  Â  Â  Â  Download Sample JSON: <a href="data-sample-en.json" download="data-sample-en.json">English</a> | <a href="data-sample-zh.json" download="data-sample-zh.json">Chinese</a> | <a href="data-sample-jp.json" download="data-sample-jp.json">Japanese</a><br/>
Â  Â  Â  Â  Â  Â  View Required Schema (.yaml): <a href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml" target="_blank">https://wesleywaihk.github.io/dialogue-generator/schema.yaml</a>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="dialogue-controls">
Â  Â  Â  Â  <h2>Reader Settings</h2>
Â  Â  Â  Â  <label for="rateSlider">Speech Rate: <span id="rateValue">1.0</span></label>
Â  Â  Â  Â  <input type="range" id="rateSlider" min="0.5" max="2.0" value="1.0" step="0.1">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p>
Â  Â  Â  Â  Â  Â  <button id="readAllBtn" disabled>â–¶ï¸ Read All Dialogue</button>
Â  Â  Â  Â  Â  Â  <button id="stopBtn" disabled>â¹ï¸ Stop Reading</button>
Â  Â  Â  Â  </p>
Â  Â  Â  Â  <p>Click any line below to read it individually.</p>
Â  Â  </div>

Â  Â  <h2>ğŸ“œ Dialogue Content</h2>
Â  Â  <div id="dialogueContainer">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="how-to-use">
Â  Â  Â  Â  Â  Â  <h3>How to Use This Reader</h3>
Â  Â  Â  Â  Â  Â  <ol>
Â  Â  Â  Â  Â  Â  Â  Â  <li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Generate Dialogue:</strong> Use an AI tool (like ChatGPT, Gemini, etc.) to generate a dialogue script. Specify the language and the speakers.
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Export to JSON:</strong> Ask the AI to export the generated dialogue script as a **JSON file** that strictly follows this **Swagger/OpenAPI schema**:Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml" target="_blank">View Required Schema (schema.yaml)</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>The JSON structure must include <code>"language_code"</code> and an array named <code>"dialogue"</code> with <code>"speaker"</code> and <code>"text"</code> for each line.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Upload:</strong> Click the **"Upload JSON Dialogue File"** button above and select your generated JSON file (or use the provided sample file).
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  <li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Read:</strong> Use the **"Read All Dialogue"** button or click on individual lines to hear the conversation using your browser's native Text-to-Speech (TTS) voices.
Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  </ol>
Â  Â  Â  Â  Â  Â  <p>We use your device's built-in, free Text-to-Speech engine. No extra charges, ever!</p>

Â  Â  Â  Â  Â  Â  <p>Android Edge Tip: If the speech doesn't start automatically, look for and enable your browser's 'Read Aloud' setting.</p>

Â  Â  Â  Â  Â  Â  <p>iPhone/iOS Users: We are aware that the speech quality on iPhones can sometimes be poor. We hope future browser updates will improve this experience!</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  </div>

Â  Â  <div id="log">
Â  Â  Â  Â  <strong>Message Log:</strong><br>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const synth = window.speechSynthesis;
Â  Â  Â  Â  const dialogueContainer = document.getElementById('dialogueContainer');
Â  Â  Â  Â  const fileInput = document.getElementById('fileInput');
Â  Â  Â  Â  const rateSlider = document.getElementById('rateSlider');
Â  Â  Â  Â  const rateValueSpan = document.getElementById('rateValue');
Â  Â  Â  Â  const readAllBtn = document.getElementById('readAllBtn');
Â  Â  Â  Â  const stopBtn = document.getElementById('stopBtn');
Â  Â  Â  Â  const logDiv = document.getElementById('log');

Â  Â  Â  Â  let dialogueData = null;
Â  Â  Â  Â  let voices = [];
Â  Â  Â  Â  let currentUtterance = null;
Â  Â  Â  Â  let dialogueIndex = 0; // Index for reading all
Â  Â  Â  Â  const howToUseHtml = document.querySelector('.how-to-use').outerHTML; // Store the initial content

Â  Â  Â  Â  // --- Voice Initialization ---
Â  Â  Â  Â  function populateVoices() {
Â  Â  Â  Â  Â  Â  voices = synth.getVoices();
Â  Â  Â  Â  Â  Â  logMessage(`Found ${voices.length} system voices.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (synth.onvoiceschanged !== undefined) {
Â  Â  Â  Â  Â  Â  synth.onvoiceschanged = populateVoices;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  populateVoices();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Utility Functions ---
Â  Â  Â  Â  function logMessage(message, isError = false) {
Â  Â  Â  Â  Â  Â  const time = new Date().toLocaleTimeString('en-US');
Â  Â  Â  Â  Â  Â  const color = isError ? 'red' : 'green';
Â  Â  Â  Â  Â  Â  logDiv.innerHTML = `<span style="color:${color};">[${time}] ${message}</span><br>` + logDiv.innerHTML;
Â  Â  Â  Â  Â  Â  logDiv.scrollTop = 0; // Scroll to the top to see the latest message
Â  Â  Â  Â  }

Â  Â  Â  Â  function getVoice(lang, speakerName) {
Â  Â  Â  Â  Â  Â  // 1. Try to match by language AND speaker name hint
Â  Â  Â  Â  Â  Â  let voiceMatch = voices.find(v =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  v.lang.startsWith(lang) &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  v.name.toLowerCase().includes(speakerName.toLowerCase())
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Fallback: Match by language only
Â  Â  Â  Â  Â  Â  if (!voiceMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  voiceMatch = voices.find(v => v.lang.startsWith(lang));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return voiceMatch;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Core TTS Function ---
Â  Â  Â  Â  function speak(text, lang, speakerName, lineElement, isAllMode = false, callback = () => {}) {
Â  Â  Â  Â  Â  Â  // Stop current speech if not in continuous mode
Â  Â  Â  Â  Â  Â  if (!isAllMode && synth.speaking) {
Â  Â  Â  Â  Â  Â  Â  Â  synth.cancel();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const utterance = new SpeechSynthesisUtterance(text);
Â  Â  Â  Â  Â  Â  utterance.rate = parseFloat(rateSlider.value);

Â  Â  Â  Â  Â  Â  const voiceMatch = getVoice(lang, speakerName);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (voiceMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  utterance.voice = voiceMatch;
Â  Â  Â  Â  Â  Â  Â  Â  logMessage(`Using voice: ${voiceMatch.name} (${voiceMatch.lang}) for ${speakerName}`);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  utterance.lang = lang;Â 
Â  Â  Â  Â  Â  Â  Â  Â  logMessage(`No specific voice found. Using default voice for language: ${lang}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  currentUtterance = utterance;

Â  Â  Â  Â  Â  Â  // Highlight the speaking line
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.current-speaking').forEach(el => el.classList.remove('current-speaking'));
Â  Â  Â  Â  Â  Â  if (lineElement) {
Â  Â  Â  Â  Â  Â  Â  Â  lineElement.classList.add('current-speaking');
Â  Â  Â  Â  Â  Â  Â  Â  lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  stopBtn.disabled = false;

Â  Â  Â  Â  Â  Â  utterance.onend = () => {
Â  Â  Â  Â  Â  Â  Â  Â  logMessage(`Speech ended: ${text.substring(0, 30)}...`);
Â  Â  Â  Â  Â  Â  Â  Â  // Clear highlight only if not transitioning immediately in readAll mode
Â  Â  Â  Â  Â  Â  Â  Â  if (!isAllMode || dialogueIndex >= dialogueData.dialogue.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.current-speaking').forEach(el => el.classList.remove('current-speaking'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  readAllBtn.disabled = !dialogueData || false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  currentUtterance = null;
Â  Â  Â  Â  Â  Â  Â  Â  callback();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  utterance.onerror = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  logMessage(`TTS Error for ${speakerName}: ${event.error}`, true);
Â  Â  Â  Â  Â  Â  Â  Â  currentUtterance = null;
Â  Â  Â  Â  Â  Â  Â  Â  callback();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  synth.speak(utterance);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Single Line Reading ---
Â  Â  Â  Â  function handleLineClick(event) {
Â  Â  Â  Â  Â  Â  const lineElement = event.currentTarget;
Â  Â  Â  Â  Â  Â  const index = parseInt(lineElement.dataset.index);
Â  Â  Â  Â  Â  Â  const line = dialogueData.dialogue[index];

Â  Â  Â  Â  Â  Â  // Stop continuous reading
Â  Â  Â  Â  Â  Â  if (synth.speaking && dialogueIndex < dialogueData.dialogue.length) {
Â  Â  Â  Â  Â  Â  Â  Â  synth.cancel();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  speak(line.text, dialogueData.language_code, line.speaker, lineElement, false);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Read All Dialogue ---
Â  Â  Â  Â  function readAllDialogue() {
Â  Â  Â  Â  Â  Â  if (!dialogueData) return;

Â  Â  Â  Â  Â  Â  synth.cancel(); // Stop any previous speech
Â  Â  Â  Â  Â  Â  dialogueIndex = 0;
Â  Â  Â  Â  Â  Â  readAllBtn.disabled = true;
Â  Â  Â  Â  Â  Â  logMessage('Starting continuous reading...');
Â  Â  Â  Â  Â  Â  readNextLine();
Â  Â  Â  Â  }

Â  Â  Â  Â  function readNextLine() {
Â  Â  Â  Â  Â  Â  if (!dialogueData || dialogueIndex >= dialogueData.dialogue.length) {
Â  Â  Â  Â  Â  Â  Â  Â  logMessage('All dialogue lines finished.');
Â  Â  Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  readAllBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.current-speaking').forEach(el => el.classList.remove('current-speaking'));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const line = dialogueData.dialogue[dialogueIndex];
Â  Â  Â  Â  Â  Â  const lineElement = document.querySelector(`.dialogue-line[data-index="${dialogueIndex}"]`);

Â  Â  Â  Â  Â  Â  speak(line.text, dialogueData.language_code, line.speaker, lineElement, true, () => {
Â  Â  Â  Â  Â  Â  Â  Â  // This callback runs after onend or onerror
Â  Â  Â  Â  Â  Â  Â  Â  dialogueIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  readNextLine();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Stop Function ---
Â  Â  Â  Â  function stopReading() {
Â  Â  Â  Â  Â  Â  synth.cancel();
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.current-speaking').forEach(el => el.classList.remove('current-speaking'));
Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  readAllBtn.disabled = !dialogueData || false;
Â  Â  Â  Â  Â  Â  logMessage('Reading stopped by user.');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- JSON Handling ---
Â  Â  Â  Â  fileInput.addEventListener('change', (event) => {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Basic validation based on schema requirements
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.language_code || !Array.isArray(data.dialogue)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Invalid JSON format: Missing "language_code" or "dialogue" array.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dialogueData = data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDialogue(dialogueData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  readAllBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logMessage('JSON file loaded successfully.');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dialogueContainer.innerHTML = `<p style="color: red;">JSON Parsing Error. Please ensure the file follows the specified schema.</p>${howToUseHtml}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  readAllBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logMessage(`JSON Parsing Error: ${err.message}`, true);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Rendering Dialogue ---
Â  Â  Â  Â  function renderDialogue(data) {
Â  Â  Â  Â  Â  Â  dialogueContainer.innerHTML = ''; // Clear existing content (including how-to-use)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const langH3 = document.createElement('h3');
Â  Â  Â  Â  Â  Â  langH3.textContent = `Language Code: ${data.language_code}`;
Â  Â  Â  Â  Â  Â  dialogueContainer.appendChild(langH3);

Â  Â  Â  Â  Â  Â  data.dialogue.forEach((line, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const lineDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  lineDiv.className = 'dialogue-line';
Â  Â  Â  Â  Â  Â  Â  Â  lineDiv.dataset.index = index;
Â  Â  Â  Â  Â  Â  Â  Â  lineDiv.innerHTML = `<span class="speaker">${line.speaker}:</span><span>${line.text}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  lineDiv.addEventListener('click', handleLineClick);
Â  Â  Â  Â  Â  Â  Â  Â  dialogueContainer.appendChild(lineDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  logMessage('Dialogue content displayed.');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â  rateSlider.addEventListener('input', () => {
Â  Â  Â  Â  Â  Â  rateValueSpan.textContent = rateSlider.value;
Â  Â  Â  Â  Â  Â  // Update rate instantly if speaking
Â  Â  Â  Â  Â  Â  if (currentUtterance && !synth.paused) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUtterance.rate = parseFloat(rateSlider.value);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  readAllBtn.addEventListener('click', readAllDialogue);
Â  Â  Â  Â  stopBtn.addEventListener('click', stopReading);

Â  Â  Â  Â  // Ensure initial state
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  readAllBtn.disabled = true;
Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
