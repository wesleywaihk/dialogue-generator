<!DOCTYPE html>
<html lang="en">
  Â 
  <head>
    Â  Â 
    <meta charset="UTF-8" />
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    Â  Â 
    <title>JSON Dialogue TTS Reader</title>
    Â  Â 
    <style>
      Â  Â  Â  body {
      Â  Â  Â  Â  font-family: Arial, sans-serif;
      Â  Â  Â  Â  padding: 20px;
      Â  Â  Â  }
      Â  Â  Â  .controls,
      Â  Â  Â  .dialogue-controls,
      Â  Â  Â  .how-to-use {
      Â  Â  Â  Â  margin-bottom: 20px;
      Â  Â  Â  Â  padding: 15px;
      Â  Â  Â  Â  border: 1px solid #ccc;
      Â  Â  Â  Â  border-radius: 5px;
      Â  Â  Â  }
      Â  Â  Â  .dialogue-line {
      Â  Â  Â  Â  margin-bottom: 10px;
      Â  Â  Â  Â  padding: 10px;
      Â  Â  Â  Â  border-bottom: 1px dashed #eee;
      Â  Â  Â  Â  cursor: pointer;
      Â  Â  Â  }
      Â  Â  Â  .dialogue-line:hover {
      Â  Â  Â  Â  background-color: #f0f0f0;
      Â  Â  Â  }
      Â  Â  Â  .speaker {
      Â  Â  Â  Â  font-weight: bold;
      Â  Â  Â  Â  margin-right: 10px;
      Â  Â  Â  Â  color: #0056b3;
      Â  Â  Â  }
      Â  Â  Â  .current-speaking {
      Â  Â  Â  Â  background-color: #e6f7ff;
      Â  Â  Â  Â  border-left: 5px solid #007bff;
      Â  Â  Â  }
      Â  Â  Â  label {
      Â  Â  Â  Â  display: block;
      Â  Â  Â  Â  margin-bottom: 5px;
      Â  Â  Â  Â  font-weight: bold;
      Â  Â  Â  }
      Â  Â  Â  input[type="range"] {
      Â  Â  Â  Â  width: 300px;
      Â  Â  Â  }
      Â  Â  Â  button {
      Â  Â  Â  Â  padding: 10px 15px;
      Â  Â  Â  Â  margin-right: 10px;
      Â  Â  Â  Â  cursor: pointer;
      Â  Â  Â  }
      Â  Â  Â  #log {
      Â  Â  Â  Â  margin-top: 20px;
      Â  Â  Â  Â  padding: 10px;
      Â  Â  Â  Â  background-color: #f9f9f9;
      Â  Â  Â  Â  border: 1px solid #ddd;
      Â  Â  Â  Â  max-height: 150px;
      Â  Â  Â  Â  overflow-y: auto;
      Â  Â  Â  Â  font-size: 0.9em;
      Â  Â  Â  }
      Â  Â  Â  .how-to-use {
      Â  Â  Â  Â  background-color: #e6f7ff;
      Â  Â  Â  Â  border-color: #b3d9ff;
      Â  Â  Â  }
      Â  Â  Â  .how-to-use ol li {
      Â  Â  Â  Â  margin-bottom: 10px;
      Â  Â  Â  }
      Â  Â  Â  .download-links {
      Â  Â  Â  Â  margin-top: 15px;
      Â  Â  Â  Â  font-size: 0.95em;
      Â  Â  Â  }
      Â  Â 
    </style>
    Â 
  </head>
  Â 
  <body>
    Â  Â 
    <h1>ğŸ—£ï¸ JSON Dialogue TTS Reader</h1>

    Â  Â 
    <div class="controls">
      Â  Â  Â  <label for="fileInput">Upload JSON Dialogue File:</label> Â  Â  Â 
      <input type="file" id="fileInput" accept="application/json" /> Â  Â  Â 
      <button id="eraseDataBtn" disabled>âŒ Erase Stored Data</button> Â  Â  Â 
      <div class="download-links">
        Â  Â  Â  Â  ğŸ”— **Resources:** Download Sample JSON: Â  Â  Â  Â 
        <a href="data-sample-en.json" download="data-sample-en.json">English</a>
        Â  Â  Â  Â  | Â  Â  Â  Â 
        <a href="data-sample-zh.json" download="data-sample-zh.json">Chinese</a>
        Â  Â  Â  Â  | Â  Â  Â  Â 
        <a href="data-sample-jp.json" download="data-sample-jp.json">Japanese</a
        ><br />
        Â  Â  Â  Â  View Required Schema (.yaml): Â  Â  Â  Â 
        <a
          href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml"
          target="_blank"
          >https://wesleywaihk.github.io/dialogue-generator/schema.yaml</a
        >
        Â  Â  Â 
      </div>
      Â  Â 
    </div>

    Â  Â 
    <div class="dialogue-controls">
      Â  Â  Â 
      <h2>Reader Settings</h2>
      Â  Â  Â 
      <label for="rateSlider"
        >Speech Rate: <span id="rateValue">1.0</span></label
      >
      Â  Â  Â 
      <input
        type="range"
        id="rateSlider"
        min="0.5"
        max="2.0"
        value="1.0"
        step="0.1"
      />

      Â  Â  Â 
      <p>
        Â  Â  Â  Â  <button id="readAllBtn" disabled>â–¶ï¸ Read All Dialogue</button> Â 
        Â  Â  Â  <button id="stopBtn" disabled>â¹ï¸ Stop Reading</button> Â  Â  Â 
      </p>
      Â  Â  Â 
      <p>Click any line below to read it individually.</p>
      Â  Â 
    </div>

    Â  Â 
    <h2>ğŸ“œ Dialogue Content</h2>
    Â  Â 
    <div id="dialogueContainer">
      Â  Â  Â 
      <div class="how-to-use">
        Â  Â  Â  Â 
        <h3>How to Use This Reader</h3>
        Â  Â  Â  Â 
        <ol>
          Â  Â  Â  Â  Â 
          <li>
            Â  Â  Â  Â  Â  Â  <strong>Generate Dialogue:</strong> Prepare your own
            dialogue. Â  Â  Â  Â  Â 
          </li>
          Â  Â  Â  Â  Â 
          <li>
            Â  Â  Â  Â  Â  Â  <strong>Export to JSON:</strong> Export the generated
            dialogue Â  Â  Â  Â  Â  Â  script as a **JSON file** that strictly follows
            this Â  Â  Â  Â  Â  Â  **Swagger/OpenAPI schema**: Â  Â  Â  Â  Â  Â 
            <a
              href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml"
              target="_blank"
              >View Required Schema (schema.yaml)</a
            >
            Â  Â  Â  Â  Â  Â 
            <p>
              Â  Â  Â  Â  Â  Â  Â  The JSON structure must include
              <code>"language_code"</code> and Â  Â  Â  Â  Â  Â  Â  an array named
              <code>"dialogue"</code> with Â  Â  Â  Â  Â  Â  Â 
              <code>"speaker"</code> and <code>"text"</code> for each line. Â  Â 
              Â  Â  Â  Â 
            </p>
            Â  Â  Â  Â  Â  Â 
            <p>
              Â  Â  Â  Â  Â  Â  Â  Sample JSON: Â  Â  Â  Â  Â  Â  Â 
              <a href="data-sample-en.json" download="data-sample-en.json"
                >English</a
              >
              Â  Â  Â  Â  Â  Â  Â  | Â  Â  Â  Â  Â  Â  Â 
              <a href="data-sample-zh.json" download="data-sample-zh.json"
                >Chinese</a
              >
              Â  Â  Â  Â  Â  Â  Â  | Â  Â  Â  Â  Â  Â  Â 
              <a href="data-sample-jp.json" download="data-sample-jp.json"
                >Japanese</a
              ><br />
              Â  Â  Â  Â  Â  Â 
            </p>
            Â  Â  Â  Â  Â 
          </li>
          Â  Â  Â  Â  Â 
          <li>
            Â  Â  Â  Â  Â  Â  <strong>Upload:</strong> Click the **"Upload JSON
            Dialogue File"** Â  Â  Â  Â  Â  Â  button above and select your generated
            JSON file. Â  Â  Â  Â  Â 
          </li>
          Â  Â  Â  Â  Â 
          <li>
            Â  Â  Â  Â  Â  Â  <strong>Read:</strong> Use the **"Read All Dialogue"**
            button or Â  Â  Â  Â  Â  Â  click on individual lines to hear the
            conversation using your Â  Â  Â  Â  Â  Â  browser's native Text-to-Speech
            (TTS) voices. Â  Â  Â  Â  Â 
          </li>
          Â  Â  Â  Â 
        </ol>
        Â  Â  Â  Â 
        <p>
          Â  Â  Â  Â  Â  We use your device's built-in, free Text-to-Speech engine.
          No extra Â  Â  Â  Â  Â  charges, ever! Â  Â  Â  Â 
        </p>
        Â  Â  Â  Â 
        <p>
          Â  Â  Â  Â  Â  Android Edge Tip: If the speech doesn't start automatically,
          look for Â  Â  Â  Â  Â  and enable your browser's 'Read Aloud' setting. Â  Â 
          Â  Â 
        </p>
        Â  Â  Â  Â 
        <p>
          Â  Â  Â  Â  Â  iPhone/iOS Users: We are aware that the speech quality on
          iPhones can Â  Â  Â  Â  Â  sometimes be poor. We hope future browser
          updates will improve this Â  Â  Â  Â  Â  experience! Â  Â  Â  Â 
        </p>
        Â  Â  Â 
      </div>
      Â  Â 
    </div>

    Â  Â 
    <div id="log"><strong>Message Log:</strong><br /></div>

    Â  Â 
    <script>
      const synth = window.speechSynthesis;
      const dialogueContainer = document.getElementById("dialogueContainer");
      const fileInput = document.getElementById("fileInput");
      const rateSlider = document.getElementById("rateSlider");
      const rateValueSpan = document.getElementById("rateValue");
      const readAllBtn = document.getElementById("readAllBtn");
      const stopBtn = document.getElementById("stopBtn");
      const logDiv = document.getElementById("log");
      const eraseDataBtn = document.getElementById("eraseDataBtn");
      const STORAGE_KEY = "ttsDialogueData";

      let dialogueData = null;
      let voices = [];
      let currentUtterance = null;
      let dialogueIndex = 0;
      let speakerVoiceMap = {}; // FIX 1: Map to store the assigned voice for each unique speaker
      const howToUseHtml = document.querySelector(".how-to-use").outerHTML; // --- Voice Initialization ---

      function populateVoices() {
        voices = synth.getVoices();
        logMessage(`Found ${voices.length} system voices.`); // FIX 3: Initialize speaker map if data is already loaded
        if (dialogueData) {
          initializeVoicesForDialogue();
        }
      }

      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = populateVoices;
      } else {
        populateVoices();
      } // --- Utility Functions ---

      function logMessage(message, isError = false) {
        const time = new Date().toLocaleTimeString("en-US");
        const color = isError ? "red" : "green";
        logDiv.innerHTML =
          `<span style="color:${color};">[${time}] ${message}</span><br>` +
          logDiv.innerHTML;
        logDiv.scrollTop = 0;
      } // FIX 2: Function to map unique speakers to distinct available voices
      function initializeVoicesForDialogue() {
        speakerVoiceMap = {}; // Clear map
        if (!dialogueData || voices.length === 0) return;

        const targetLang = dialogueData.language_code; // Filter voices that match the target language
        const langVoices = voices.filter((v) => v.lang.startsWith(targetLang));

        if (langVoices.length === 0) {
          logMessage(
            `Warning: No voices found for language code ${targetLang}. Using default browser voice.`,
            true
          );
          return;
        } // Get unique speakers from the dialogue

        const uniqueSpeakers = [
          ...new Set(dialogueData.dialogue.map((line) => line.speaker)),
        ];

        uniqueSpeakers.forEach((speaker, index) => {
          // Assign voices in a round-robin manner (index % length)
          const voiceIndex = index % langVoices.length;
          const selectedVoice = langVoices[voiceIndex];
          speakerVoiceMap[speaker] = selectedVoice;
          logMessage(
            `Mapped speaker **${speaker}** to voice: **${selectedVoice.name}**`
          );
        });
      } // FIX 4: Updated getVoice to prioritize the reliable speakerVoiceMap

      function getVoice(lang, speakerName) {
        // 1. Use the pre-mapped voice for consistent speaker assignment
        if (speakerVoiceMap[speakerName]) {
          return speakerVoiceMap[speakerName];
        } // 2. Fallback: Match by language only (Original Fallback)

        return voices.find((v) => v.lang.startsWith(lang));
      } // --- Core TTS Function ---

      function speak(
        text,
        lang,
        speakerName,
        lineElement,
        isAllMode = false,
        callback = () => {}
      ) {
        if (!isAllMode && synth.speaking) {
          synth.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = parseFloat(rateSlider.value);

        const voiceMatch = getVoice(lang, speakerName);

        if (voiceMatch) {
          utterance.voice = voiceMatch;
          logMessage(
            `Using voice: ${voiceMatch.name} (${voiceMatch.lang}) for ${speakerName}`
          );
        } else {
          utterance.lang = lang;
          logMessage(
            `No specific voice found. Using default voice for language: ${lang}`
          );
        }

        currentUtterance = utterance;

        document
          .querySelectorAll(".current-speaking")
          .forEach((el) => el.classList.remove("current-speaking"));
        if (lineElement) {
          lineElement.classList.add("current-speaking");
          lineElement.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        stopBtn.disabled = false;

        utterance.onend = () => {
          logMessage(`Speech ended: ${text.substring(0, 30)}...`);
          if (!isAllMode || dialogueIndex >= dialogueData.dialogue.length) {
            document
              .querySelectorAll(".current-speaking")
              .forEach((el) => el.classList.remove("current-speaking"));
            stopBtn.disabled = true;
            readAllBtn.disabled = !dialogueData || false;
          }
          currentUtterance = null;
          callback();
        };

        utterance.onerror = (event) => {
          logMessage(`TTS Error for ${speakerName}: ${event.error}`, true);
          currentUtterance = null;
          callback();
        };

        synth.speak(utterance);
      } // --- Single Line Reading ---

      function handleLineClick(event) {
        const lineElement = event.currentTarget;
        const index = parseInt(lineElement.dataset.index);
        const line = dialogueData.dialogue[index];

        if (synth.speaking && dialogueIndex < dialogueData.dialogue.length) {
          synth.cancel();
        }

        speak(
          line.text,
          dialogueData.language_code,
          line.speaker,
          lineElement,
          false
        );
      } // --- Read All Dialogue ---

      function readAllDialogue() {
        if (!dialogueData) return;

        synth.cancel();
        dialogueIndex = 0;
        readAllBtn.disabled = true;
        logMessage("Starting continuous reading...");
        readNextLine();
      }

      function readNextLine() {
        if (!dialogueData || dialogueIndex >= dialogueData.dialogue.length) {
          logMessage("All dialogue lines finished.");
          stopBtn.disabled = true;
          readAllBtn.disabled = false;
          document
            .querySelectorAll(".current-speaking")
            .forEach((el) => el.classList.remove("current-speaking"));
          return;
        }

        const line = dialogueData.dialogue[dialogueIndex];
        const lineElement = document.querySelector(
          `.dialogue-line[data-index="${dialogueIndex}"]`
        );

        speak(
          line.text,
          dialogueData.language_code,
          line.speaker,
          lineElement,
          true,
          () => {
            dialogueIndex++;
            readNextLine();
          }
        );
      } // --- Stop Function ---

      function stopReading() {
        synth.cancel();
        document
          .querySelectorAll(".current-speaking")
          .forEach((el) => el.classList.remove("current-speaking"));
        stopBtn.disabled = true;
        readAllBtn.disabled = !dialogueData || false;
        logMessage("Reading stopped by user.");
      } // --- Local Storage Functions ---

      function saveDataToLocalStorage(data) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          logMessage("Dialogue saved to local storage.");
          eraseDataBtn.disabled = false;
        } catch (e) {
          logMessage("Could not save to local storage.", true);
        }
      }

      function restoreDataFromLocalStorage() {
        try {
          const storedData = localStorage.getItem(STORAGE_KEY);
          if (storedData) {
            const data = JSON.parse(storedData);
            if (data.language_code && Array.isArray(data.dialogue)) {
              dialogueData = data;
              renderDialogue(dialogueData); // Initialize voices after data restore
              if (voices.length > 0) {
                initializeVoicesForDialogue();
              }

              readAllBtn.disabled = false;
              logMessage("Dialogue restored from local storage.");
              eraseDataBtn.disabled = false;
              return true;
            }
          }
        } catch (e) {
          logMessage("Error restoring data from local storage.", true);
        }
        eraseDataBtn.disabled = true;
        return false;
      }

      function eraseLocalStorageData() {
        if (
          confirm("Are you sure you want to erase the stored dialogue data?")
        ) {
          localStorage.removeItem(STORAGE_KEY);
          dialogueData = null;
          dialogueContainer.innerHTML = howToUseHtml;
          readAllBtn.disabled = true;
          eraseDataBtn.disabled = true;
          synth.cancel();
          logMessage("Stored dialogue data erased successfully.");
        }
      } // --- JSON Handling ---

      fileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!data.language_code || !Array.isArray(data.dialogue)) {
              throw new Error(
                'Invalid JSON format: Missing "language_code" or "dialogue" array.'
              );
            }
            dialogueData = data;
            renderDialogue(dialogueData); // FIX 5: Initialize the voice map after loading and parsing a new file

            if (voices.length > 0) {
              initializeVoicesForDialogue();
            }

            readAllBtn.disabled = false;
            logMessage("JSON file loaded successfully."); // Save the newly loaded data

            saveDataToLocalStorage(dialogueData);
          } catch (err) {
            dialogueContainer.innerHTML = `<p style="color: red;">JSON Parsing Error. Please ensure the file follows the specified schema.</p>${howToUseHtml}`;
            readAllBtn.disabled = true;
            eraseDataBtn.disabled = localStorage.getItem(STORAGE_KEY)
              ? false
              : true;
            logMessage(`JSON Parsing Error: ${err.message}`, true);
          }
        };
        reader.readAsText(file);
      }); // --- Rendering Dialogue ---

      function renderDialogue(data) {
        dialogueContainer.innerHTML = "";

        const langH3 = document.createElement("h3");
        langH3.textContent = `Language Code: ${data.language_code}`;
        dialogueContainer.appendChild(langH3);

        data.dialogue.forEach((line, index) => {
          const lineDiv = document.createElement("div");
          lineDiv.className = "dialogue-line";
          lineDiv.dataset.index = index;
          lineDiv.innerHTML = `<span class="speaker">${line.speaker}:</span><span>${line.text}</span>`;
          lineDiv.addEventListener("click", handleLineClick);
          dialogueContainer.appendChild(lineDiv);
        });
        logMessage("Dialogue content displayed.");
      } // --- Event Listeners ---

      rateSlider.addEventListener("input", () => {
        rateValueSpan.textContent = rateSlider.value;
        if (currentUtterance && !synth.paused) {
          currentUtterance.rate = parseFloat(rateSlider.value);
        }
      });

      readAllBtn.addEventListener("click", readAllDialogue);
      stopBtn.addEventListener("click", stopReading);
      eraseDataBtn.addEventListener("click", eraseLocalStorageData); // Ensure initial state and attempt to restore data on load

      document.addEventListener("DOMContentLoaded", () => {
        readAllBtn.disabled = true;
        stopBtn.disabled = true;
        eraseDataBtn.disabled = true; // Attempt to restore data on page load

        if (!restoreDataFromLocalStorage()) {
          if (dialogueContainer.innerHTML === "") {
            dialogueContainer.innerHTML = howToUseHtml;
          }
        }
      });
    </script>
    Â 
  </body>
</html>
