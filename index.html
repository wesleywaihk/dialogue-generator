<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Dialogue TTS Reader</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .controls, .dialogue-controls, .how-to-use { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .dialogue-line { margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #eee; cursor: pointer; }
        .dialogue-line:hover { background-color: #f0f0f0; }
        .speaker { font-weight: bold; margin-right: 10px; color: #0056b3; }
        .current-speaking { background-color: #e6f7ff; border-left: 5px solid #007bff; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 300px; }
        button { padding: 10px 15px; margin-right: 10px; cursor: pointer; }
        #log { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; font-size: 0.9em; }
        .how-to-use { background-color: #e6f7ff; border-color: #b3d9ff; }
        .how-to-use ol li { margin-bottom: 10px; }
        .download-links { margin-top: 15px; font-size: 0.95em; }
    </style>
</head>
<body>

    <h1>üó£Ô∏è JSON Dialogue TTS Reader</h1>

    <div class="controls">
        <label for="fileInput">Upload JSON Dialogue File:</label>
        <input type="file" id="fileInput" accept="application/json">
        
        <div class="download-links">
            üîó **Resources:**
            <a href="sample-data.json" download="sample-data.json">Download Sample JSON</a>
            |
            <a href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml" target="_blank">View Required Schema (.yaml)</a>
        </div>
    </div>

    <div class="dialogue-controls">
        <h2>Reader Settings</h2>
        <label for="rateSlider">Speech Rate: <span id="rateValue">1.0</span></label>
        <input type="range" id="rateSlider" min="0.5" max="2.0" value="1.0" step="0.1">
        
        <p>
            <button id="readAllBtn" disabled>‚ñ∂Ô∏è Read All Dialogue</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Stop Reading</button>
        </p>
        <p>Click any line below to read it individually.</p>
    </div>

    <h2>üìú Dialogue Content</h2>
    <div id="dialogueContainer">
        
        <div class="how-to-use">
            <h3>How to Use This Reader</h3>
            <ol>
                <li>
                    <strong>Generate Dialogue:</strong> Use an AI tool (like ChatGPT, Gemini, etc.) to generate a dialogue script. Specify the language and the speakers.
                </li>
                <li>
                    <strong>Export to JSON:</strong> Ask the AI to export the generated dialogue script as a **JSON file** that strictly follows this **Swagger/OpenAPI schema**: 
                    <a href="https://wesleywaihk.github.io/dialogue-generator/schema.yaml" target="_blank">View Required Schema (schema.yaml)</a>
                    <p>The JSON structure must include <code>"language_code"</code> and an array named <code>"dialogue"</code> with <code>"speaker"</code> and <code>"text"</code> for each line.</p>
                </li>
                <li>
                    <strong>Upload:</strong> Click the **"Upload JSON Dialogue File"** button above and select your generated JSON file (or use the provided sample file).
                </li>
                <li>
                    <strong>Read:</strong> Use the **"Read All Dialogue"** button or click on individual lines to hear the conversation using your browser's native Text-to-Speech (TTS) voices.
                </li>
            </ol>
        </div>
        
    </div>

    <div id="log">
        <strong>Message Log:</strong><br>
    </div>

    <script>
        const synth = window.speechSynthesis;
        const dialogueContainer = document.getElementById('dialogueContainer');
        const fileInput = document.getElementById('fileInput');
        const rateSlider = document.getElementById('rateSlider');
        const rateValueSpan = document.getElementById('rateValue');
        const readAllBtn = document.getElementById('readAllBtn');
        const stopBtn = document.getElementById('stopBtn');
        const logDiv = document.getElementById('log');

        let dialogueData = null;
        let voices = [];
        let currentUtterance = null;
        let dialogueIndex = 0; // Index for reading all
        const howToUseHtml = document.querySelector('.how-to-use').outerHTML; // Store the initial content

        // --- Voice Initialization ---
        function populateVoices() {
            voices = synth.getVoices();
            logMessage(`Found ${voices.length} system voices.`);
        }

        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoices;
        } else {
            populateVoices();
        }

        // --- Utility Functions ---
        function logMessage